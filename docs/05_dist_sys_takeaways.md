# ë¶„ì‚° ì‹œìŠ¤í…œ ê´€ì ì—ì„œ ë°”ë¼ë³¸ HTTP ì„œë²„

> **ìš”ì•½**: HTTP ì„œë²„ì—ì„œ ë°°ìš´ timeout, graceful shutdown, ìì› ë³´í˜¸ ê°œë…ì´
> ë¸”ë¡ì²´ì¸ ë…¸ë“œ, RPC ì„œë²„, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ì–´ë–»ê²Œ ì ìš©ë˜ëŠ”ì§€ ì •ë¦¬í•œë‹¤.

---

## 1. í•µì‹¬ í†µì°°: ì™œ ì´ê²Œ ì¤‘ìš”í•œê°€?

### 1.1 RPC ë…¸ë“œë„ HTTP ì„œë²„ë‹¤

ë¸”ë¡ì²´ì¸ ë…¸ë“œì˜ JSON-RPC ì¸í„°í˜ì´ìŠ¤:

```
í´ë¼ì´ì–¸íŠ¸ (dApp, ì§€ê°‘)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          RPC Endpoint               â”‚
â”‚  (eth_call, eth_sendTransaction)    â”‚
â”‚                                     â”‚
â”‚  ë‚´ë¶€ì ìœ¼ë¡œëŠ” net/http.Server!      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   ë¸”ë¡ì²´ì¸ ìƒíƒœ
```

Geth, Reth, Cosmos SDK ë…¸ë“œ ëª¨ë‘ **Goì˜ net/http.Server**ë¥¼ ì‚¬ìš©í•œë‹¤.
ìš°ë¦¬ê°€ ë¶„ì„í•œ ëª¨ë“  ê°œë…ì´ ê·¸ëŒ€ë¡œ ì ìš©ëœë‹¤.

### 1.2 ìš°ë¦¬ê°€ ë°°ìš´ ê²ƒë“¤ì˜ ë¶„ì‚° ì‹œìŠ¤í…œ ì˜ë¯¸

| HTTP ì„œë²„ ê°œë… | ë¶„ì‚° ì‹œìŠ¤í…œ ì˜ë¯¸ |
|---------------|-----------------|
| ReadHeaderTimeout | Slow client ê³µê²© ë°©ì–´ |
| ReadTimeout | ì•…ì˜ì  ëŒ€ìš©ëŸ‰ ìš”ì²­ ì°¨ë‹¨ |
| WriteTimeout | ëŠë¦° ì†Œë¹„ìë¡œ ì¸í•œ backpressure |
| IdleTimeout | ì—°ê²° í’€ ê³ ê°ˆ ë°©ì§€ |
| Graceful Shutdown | ìƒíƒœ ì¼ê´€ì„± ë³´ì¥ |
| ConnState ì¶”ì  | ì‹œìŠ¤í…œ ê°€ì‹œì„± (observability) |

---

## 2. Timeout = Liveness ë³´ì¥

### 2.1 ì •í™•ì„± vs Liveness

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  ì •í™•ì„± (Correctness)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  "ìš”ì²­ì„ ëê¹Œì§€ ì²˜ë¦¬í•´ì•¼ í•œë‹¤"                                   â”‚
â”‚  "ë°ì´í„°ê°€ ì†ì‹¤ë˜ë©´ ì•ˆ ëœë‹¤"                                     â”‚
â”‚                                                                 â”‚
â”‚  vs                                                             â”‚
â”‚                                                                 â”‚
â”‚  Liveness (ê°€ìš©ì„±)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  "ì‹œìŠ¤í…œì´ ê³„ì† ì‘ë‹µí•´ì•¼ í•œë‹¤"                                   â”‚
â”‚  "í•˜ë‚˜ì˜ ëŠë¦° ìš”ì²­ì´ ì „ì²´ë¥¼ ë©ˆì¶”ë©´ ì•ˆ ëœë‹¤"                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Timeoutì€ "ì •í™•ì„±"ì„ í¬ê¸°í•˜ê³  "Liveness"ë¥¼ ì„ íƒí•˜ëŠ” ê²ƒì´ë‹¤.**

### 2.2 ì‹¤ì œ ì‚¬ë¡€: ì´ë”ë¦¬ì›€ ë…¸ë“œ ê³¼ë¶€í•˜

```
ì‹œë‚˜ë¦¬ì˜¤: eth_getLogs ìš”ì²­ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¼

WriteTimeout ì—†ìœ¼ë©´:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker goroutine #1: eth_getLogs (2ë¶„ì§¸ ì‹¤í–‰ ì¤‘...)            â”‚
â”‚  Worker goroutine #2: eth_getLogs (1ë¶„ì§¸ ì‹¤í–‰ ì¤‘...)            â”‚
â”‚  Worker goroutine #3: eth_getLogs (3ë¶„ì§¸ ì‹¤í–‰ ì¤‘...)            â”‚
â”‚  ...                                                            â”‚
â”‚  Worker goroutine #1000: (ëª¨ë“  ì›Œì»¤ ì ìœ !)                      â”‚
â”‚                                                                 â”‚
â”‚  ìƒˆë¡œìš´ eth_blockNumber ìš”ì²­ â†’ ì²˜ë¦¬ ë¶ˆê°€! ğŸ’€                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WriteTimeout ìˆìœ¼ë©´:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker goroutine #1: eth_getLogs â†’ 30ì´ˆ í›„ timeout â†’ í•´ì œ     â”‚
â”‚  Worker goroutine #2: eth_getLogs â†’ 30ì´ˆ í›„ timeout â†’ í•´ì œ     â”‚
â”‚                                                                 â”‚
â”‚  ìƒˆë¡œìš´ eth_blockNumber ìš”ì²­ â†’ ë°”ë¡œ ì²˜ë¦¬ ê°€ëŠ¥! âœ“                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Timeout ì„¤ê³„ ì›ì¹™

```go
// ì˜ëª»ëœ ì„¤ê³„: ëª¨ë“  ìš”ì²­ì— ê°™ì€ timeout
server := &http.Server{
    WriteTimeout: 30 * time.Second,  // eth_getLogsì—ëŠ” ë¶€ì¡±!
}

// ì˜¬ë°”ë¥¸ ì„¤ê³„: ì—”ë“œí¬ì¸íŠ¸ë³„ timeout ì œì–´
func rpcHandler(w http.ResponseWriter, r *http.Request) {
    method := parseRPCMethod(r)

    var timeout time.Duration
    switch method {
    case "eth_blockNumber":
        timeout = 1 * time.Second   // ë¹ ë¥¸ ì‘ë‹µ í•„ìˆ˜
    case "eth_getLogs":
        timeout = 60 * time.Second  // ë²”ìœ„ì— ë”°ë¼ ì˜¤ë˜ ê±¸ë¦¼
    case "eth_call":
        timeout = 10 * time.Second  // EVM ì‹¤í–‰ ì‹œê°„ ê³ ë ¤
    default:
        timeout = 5 * time.Second
    }

    ctx, cancel := context.WithTimeout(r.Context(), timeout)
    defer cancel()

    result := executeRPC(ctx, method, params)
    // ...
}
```

---

## 3. Graceful Shutdown = ìƒíƒœ ì¼ê´€ì„±

### 3.1 Shutdown ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë¸”ë¡ì²´ì¸ ë…¸ë“œ ì¢…ë£Œ ì‹œ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. In-flight HTTP ìš”ì²­                                         â”‚
â”‚     â””â”€ ìš°ë¦¬ê°€ ì‹¤í—˜í•œ ê²ƒ! (docs/04_shutdown_semantics.md)        â”‚
â”‚                                                                 â”‚
â”‚  2. Mempool ìƒíƒœ                                                â”‚
â”‚     â””â”€ ì•„ì§ ë¸”ë¡ì— í¬í•¨ ì•ˆ ëœ íŠ¸ëœì­ì…˜ë“¤                        â”‚
â”‚     â””â”€ ì €ì¥ ì•ˆ í•˜ë©´ ì¬ì‹œì‘ ì‹œ ìœ ì‹¤!                             â”‚
â”‚                                                                 â”‚
â”‚  3. ë¸”ë¡ ë™ê¸°í™” ì¤‘ê°„ ìƒíƒœ                                       â”‚
â”‚     â””â”€ 1000ê°œ ë¸”ë¡ ì¤‘ 500ê°œë§Œ ì²˜ë¦¬í•¨                            â”‚
â”‚     â””â”€ ì–´ë””ê¹Œì§€ í–ˆëŠ”ì§€ ê¸°ë¡ ì•ˆ í•˜ë©´?                            â”‚
â”‚                                                                 â”‚
â”‚  4. WAL (Write-Ahead Log)                                       â”‚
â”‚     â””â”€ DBì— ì•„ì§ flush ì•ˆ ëœ ë°ì´í„°                             â”‚
â”‚     â””â”€ fsync ì•ˆ í•˜ë©´ ì†ì‹¤!                                      â”‚
â”‚                                                                 â”‚
â”‚  5. P2P ì—°ê²°                                                    â”‚
â”‚     â””â”€ í”¼ì–´ë“¤ì—ê²Œ ì¢…ë£Œ ì•Œë¦¼                                     â”‚
â”‚     â””â”€ ì•ˆ í•˜ë©´ í”¼ì–´ê°€ timeoutê¹Œì§€ ëŒ€ê¸°                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ì˜¬ë°”ë¥¸ Shutdown ìˆœì„œ

```go
func gracefulShutdown(ctx context.Context, node *Node) error {
    // 1ë‹¨ê³„: ìƒˆ ìš”ì²­ ê±°ë¶€ (ìš°ë¦¬ê°€ ë°°ìš´ ê²ƒ!)
    log.Info().Msg("stopping HTTP server...")
    if err := node.httpServer.Shutdown(ctx); err != nil {
        log.Warn().Err(err).Msg("HTTP shutdown timeout")
    }

    // 2ë‹¨ê³„: P2P ì—°ê²° ì •ë¦¬
    log.Info().Msg("disconnecting peers...")
    node.p2p.BroadcastGoodbye()
    node.p2p.CloseAllConns()

    // 3ë‹¨ê³„: Background ì‘ì—… ì¤‘ë‹¨
    log.Info().Msg("stopping background workers...")
    node.blockSync.Stop()
    node.txPool.Stop()

    // 4ë‹¨ê³„: ìƒíƒœ ì €ì¥ (ê°€ì¥ ì¤‘ìš”!)
    log.Info().Msg("flushing state...")
    if err := node.mempool.FlushToDisk(); err != nil {
        return fmt.Errorf("mempool flush failed: %w", err)
    }
    if err := node.db.Sync(); err != nil {
        return fmt.Errorf("db sync failed: %w", err)
    }

    // 5ë‹¨ê³„: DB ì—°ê²° ì¢…ë£Œ
    log.Info().Msg("closing database...")
    node.db.Close()

    return nil
}
```

### 3.3 Shutdown Timeout ê³„ì¸µ êµ¬ì¡°

```
ì „ì²´ Shutdown Timeout: 60ì´ˆ
â”œâ”€â”€ HTTP Shutdown: 30ì´ˆ
â”‚   â””â”€ In-flight ìš”ì²­ ì™„ë£Œ ëŒ€ê¸°
â”œâ”€â”€ P2P Disconnect: 5ì´ˆ
â”‚   â””â”€ Goodbye ë©”ì‹œì§€ ì „ì†¡
â”œâ”€â”€ Background Stop: 10ì´ˆ
â”‚   â””â”€ í˜„ì¬ ì‘ì—… ì™„ë£Œ ëŒ€ê¸°
â”œâ”€â”€ State Flush: 10ì´ˆ
â”‚   â””â”€ ë””ìŠ¤í¬ ì“°ê¸°
â””â”€â”€ DB Close: 5ì´ˆ
    â””â”€ ì—°ê²° ì •ë¦¬

if 60ì´ˆ ì´ˆê³¼:
    SIGKILL â†’ ê°•ì œ ì¢…ë£Œ (ë°ì´í„° ì†ì‹¤ ìœ„í—˜!)
```

---

## 4. ìì› ê³ ê°ˆ ê³µê²© (Resource Exhaustion)

### 4.1 Slowlorisì˜ ë¶„ì‚° ì‹œìŠ¤í…œ ë²„ì „

ìš°ë¦¬ê°€ ì‹¤í—˜í•œ Slowloris (`docs/03_slowloris_experiment.md`)ì˜ ë³€í˜•ë“¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP ë ˆë²¨ (ìš°ë¦¬ê°€ ì‹¤í—˜í•¨)                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚  â€¢ Slowloris (í—¤ë” ì§€ì—°)     â†’ ReadHeaderTimeoutìœ¼ë¡œ ë°©ì–´       â”‚
â”‚  â€¢ Slow POST (ë°”ë”” ì§€ì—°)     â†’ ReadTimeoutìœ¼ë¡œ ë°©ì–´             â”‚
â”‚  â€¢ Slow Read (ì‘ë‹µ ì§€ì—°)     â†’ WriteTimeoutìœ¼ë¡œ ë°©ì–´            â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RPC ë ˆë²¨                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚  â€¢ ë¬´í•œ eth_getLogs          â†’ ë²”ìœ„ ì œí•œ í•„ìš”                   â”‚
â”‚  â€¢ ëŒ€ëŸ‰ eth_call ë°°ì¹˜        â†’ ë°°ì¹˜ í¬ê¸° ì œí•œ                   â”‚
â”‚  â€¢ ë³µì¡í•œ EVM ì‹¤í–‰           â†’ Gas limit í™œìš©                   â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  P2P ë ˆë²¨                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚  â€¢ Eclipse Attack            â†’ í”¼ì–´ ë‹¤ì–‘ì„± í™•ë³´                 â”‚
â”‚  â€¢ ì•…ì˜ì  ë¸”ë¡ ì „íŒŒ          â†’ ê²€ì¦ ì „ ì „íŒŒ ì œí•œ                â”‚
â”‚  â€¢ Gossip ìŠ¤íŒ¸               â†’ Rate limiting                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ë°©ì–´ íŒ¨í„´: Rate Limiting

```go
// HTTP ë ˆë²¨ rate limiting
func rateLimitMiddleware(next http.Handler) http.Handler {
    limiter := rate.NewLimiter(rate.Limit(100), 200)  // ì´ˆë‹¹ 100, ë²„ìŠ¤íŠ¸ 200

    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        if !limiter.Allow() {
            http.Error(w, "Too Many Requests", http.StatusTooManyRequests)
            return
        }
        next.ServeHTTP(w, r)
    })
}

// RPC ë©”ì„œë“œë³„ rate limiting
type RPCRateLimiter struct {
    limiters map[string]*rate.Limiter
}

func (l *RPCRateLimiter) Allow(method string, clientIP string) bool {
    key := method + ":" + clientIP

    limiter, exists := l.limiters[key]
    if !exists {
        // ë©”ì„œë“œë³„ ë‹¤ë¥¸ rate limit
        var limit rate.Limit
        switch method {
        case "eth_sendRawTransaction":
            limit = 10   // ì´ˆë‹¹ 10ê°œ (DoS ë°©ì§€)
        case "eth_getLogs":
            limit = 5    // ì´ˆë‹¹ 5ê°œ (ë¹„ìš©ì´ í¼)
        default:
            limit = 100  // ì¼ë°˜ ë©”ì„œë“œ
        }
        limiter = rate.NewLimiter(limit, int(limit)*2)
        l.limiters[key] = limiter
    }

    return limiter.Allow()
}
```

---

## 5. Observability: ëˆˆì— ë³´ì—¬ì•¼ ê³ ì¹œë‹¤

### 5.1 ìš°ë¦¬ê°€ êµ¬í˜„í•œ ConnStateì˜ í™•ì¥

```go
// cmd/server/main.goì—ì„œ êµ¬í˜„í•œ ConnState ì¶”ì 
server.ConnState = func(conn net.Conn, state http.ConnState) {
    metrics.connState.Transition(state)
}
```

ì´ê±¸ ë¶„ì‚° ì‹œìŠ¤í…œìœ¼ë¡œ í™•ì¥í•˜ë©´:

```go
type NodeMetrics struct {
    // HTTP ë ˆë²¨ (ìš°ë¦¬ê°€ êµ¬í˜„í•¨)
    httpConns     *ConnStateCounter

    // RPC ë ˆë²¨
    rpcCalls      *prometheus.CounterVec   // methodë³„ í˜¸ì¶œ ìˆ˜
    rpcLatency    *prometheus.HistogramVec // methodë³„ latency
    rpcErrors     *prometheus.CounterVec   // methodë³„ ì—ëŸ¬ ìˆ˜

    // P2P ë ˆë²¨
    peerCount     prometheus.Gauge         // ì—°ê²°ëœ í”¼ì–´ ìˆ˜
    peerLatency   *prometheus.HistogramVec // í”¼ì–´ë³„ latency

    // ìƒíƒœ ë ˆë²¨
    blockHeight   prometheus.Gauge         // í˜„ì¬ ë¸”ë¡ ë†’ì´
    mempoolSize   prometheus.Gauge         // mempool í¬ê¸°
    pendingTxs    prometheus.Gauge         // ëŒ€ê¸° ì¤‘ì¸ íŠ¸ëœì­ì…˜
}
```

### 5.2 ì•ŒëŒ ì„¤ì • ì˜ˆì‹œ

```yaml
# Prometheus alerting rules

groups:
  - name: rpc_node_alerts
    rules:
      # Slowloris ë¥˜ ê³µê²© íƒì§€
      - alert: HighIdleConnections
        expr: http_conn_state{state="idle"} > 1000
        for: 5m
        annotations:
          summary: "ë¹„ì •ìƒì ìœ¼ë¡œ ë§ì€ Idle ì—°ê²°"
          description: "Slowloris ê³µê²© ê°€ëŠ¥ì„±, IdleTimeout í™•ì¸ í•„ìš”"

      # RPC ê³¼ë¶€í•˜ íƒì§€
      - alert: HighRPCLatency
        expr: histogram_quantile(0.99, rpc_latency_seconds) > 10
        for: 2m
        annotations:
          summary: "RPC p99 latencyê°€ 10ì´ˆ ì´ˆê³¼"
          description: "ë…¸ë“œ ê³¼ë¶€í•˜ ë˜ëŠ” íŠ¹ì • ë©”ì„œë“œ ë¬¸ì œ"

      # Graceful shutdown ì‹¤íŒ¨ íƒì§€
      - alert: ShutdownTimeout
        expr: increase(shutdown_timeout_total[1h]) > 0
        annotations:
          summary: "Shutdown timeout ë°œìƒ"
          description: "shutdown timeout ì„¤ì • ê²€í†  í•„ìš”"
```

---

## 6. ì‹¤ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 6.1 ìƒˆ RPC ë…¸ë“œ ë°°í¬ ì „

```
â–¡ Timeout ì„¤ì • ì™„ë£Œ
  â–¡ ReadHeaderTimeout: 5ì´ˆ (Slowloris ë°©ì–´)
  â–¡ ReadTimeout: 30ì´ˆ (ëŒ€ìš©ëŸ‰ ìš”ì²­ ê³ ë ¤)
  â–¡ WriteTimeout: 60ì´ˆ (eth_getLogs ë“± ê³ ë ¤)
  â–¡ IdleTimeout: 120ì´ˆ (keep-alive ìœ ì§€)

â–¡ Rate Limiting ì„¤ì •
  â–¡ ì „ì—­ rate limit
  â–¡ ë©”ì„œë“œë³„ rate limit
  â–¡ IPë³„ rate limit

â–¡ Graceful Shutdown êµ¬í˜„
  â–¡ HTTP server shutdown
  â–¡ ìƒíƒœ ì €ì¥ (mempool, WAL)
  â–¡ ì¶©ë¶„í•œ shutdown timeout

â–¡ Observability ì„¤ì •
  â–¡ ConnState ë©”íŠ¸ë¦­
  â–¡ RPC ë©”ì„œë“œë³„ ë©”íŠ¸ë¦­
  â–¡ ì•ŒëŒ ê·œì¹™
```

### 6.2 ì¥ì•  ëŒ€ì‘ ì‹œ

```
ì¦ìƒ: RPC ì‘ë‹µ ì§€ì—°

1. ConnState í™•ì¸
   â””â”€ Active ì—°ê²°ì´ ë¹„ì •ìƒì ìœ¼ë¡œ ë§ìœ¼ë©´ â†’ Slow client ê³µê²© ì˜ì‹¬

2. RPC ë©”íŠ¸ë¦­ í™•ì¸
   â””â”€ íŠ¹ì • ë©”ì„œë“œ latency ê¸‰ì¦ â†’ í•´ë‹¹ ë©”ì„œë“œ rate limit ê°•í™”

3. ë¦¬ì†ŒìŠ¤ í™•ì¸
   â””â”€ CPU/ë©”ëª¨ë¦¬/ë””ìŠ¤í¬ I/O â†’ ìŠ¤ì¼€ì¼ì—… ë˜ëŠ” ë…¸ë“œ ì¶”ê°€

ì¦ìƒ: Shutdown timeout

1. In-flight ìš”ì²­ í™•ì¸
   â””â”€ ì–´ë–¤ ìš”ì²­ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ”ì§€ â†’ í•´ë‹¹ ìš”ì²­ timeout ì¡°ì •

2. Background ì‘ì—… í™•ì¸
   â””â”€ ë¸”ë¡ ë™ê¸°í™” ì¤‘ì´ë©´ â†’ ë” ê¸´ shutdown timeout í•„ìš”

3. State flush í™•ì¸
   â””â”€ ë””ìŠ¤í¬ I/Oê°€ ëŠë¦¬ë©´ â†’ SSDë¡œ êµì²´ ë˜ëŠ” flush ìµœì í™”
```

---

## 7. ìš”ì•½: ë°°ìš´ ê²ƒë“¤ì˜ ì—°ê²°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  net/http.Server ë‚´ë¶€ ë¶„ì„                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Timeout    â”‚     â”‚  Shutdown   â”‚     â”‚  ConnState  â”‚       â”‚
â”‚  â”‚  ë©”ì»¤ë‹ˆì¦˜   â”‚     â”‚  ì‹œë©˜í‹±ìŠ¤   â”‚     â”‚  ì¶”ì        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                   â”‚                   â”‚               â”‚
â”‚         â–¼                   â–¼                   â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              ë¶„ì‚° ì‹œìŠ¤í…œ / RPC ë…¸ë“œ                  â”‚       â”‚
â”‚  â”‚                                                     â”‚       â”‚
â”‚  â”‚  â€¢ ìì› ê³ ê°ˆ ê³µê²© ë°©ì–´    (Timeout)                 â”‚       â”‚
â”‚  â”‚  â€¢ ìƒíƒœ ì¼ê´€ì„± ë³´ì¥       (Graceful Shutdown)       â”‚       â”‚
â”‚  â”‚  â€¢ ì‹œìŠ¤í…œ ê°€ì‹œì„±          (Observability)           â”‚       â”‚
â”‚  â”‚                                                     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â”‚  í•µì‹¬ êµí›ˆ:                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  1. Timeoutì€ "ì •í™•ì„±"ì´ ì•„ë‹ˆë¼ "Liveness" ë³´ì¥ ë„êµ¬           â”‚
â”‚  2. Graceful Shutdownì€ "ìƒíƒœ flush" ë¬¸ì œì™€ ì§ê²°               â”‚
â”‚  3. ëˆˆì— ë³´ì´ì§€ ì•Šìœ¼ë©´ ê³ ì¹  ìˆ˜ ì—†ë‹¤ (Observability)            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ë” ê¹Šì´ íŒŒê³ ë“¤ê¸°

ì´ í”„ë¡œì íŠ¸ì—ì„œ ë‹¤ë£¨ì§€ ì•Šì•˜ì§€ë§Œ, ì—°ê´€ëœ ì£¼ì œë“¤:

1. **Circuit Breaker íŒ¨í„´**
   - Timeoutì´ ìì£¼ ë°œìƒí•˜ë©´ â†’ ì¼ì‹œì ìœ¼ë¡œ ìš”ì²­ ì°¨ë‹¨
   - hystrix-go, gobreaker ë¼ì´ë¸ŒëŸ¬ë¦¬

2. **Backpressure**
   - WriteTimeoutì˜ ê·¼ë³¸ ì›ì¸
   - ìƒì‚°ì-ì†Œë¹„ì ì†ë„ ë¶ˆì¼ì¹˜ ë¬¸ì œ

3. **Distributed Tracing**
   - ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¥¼ ê±°ì¹˜ëŠ” ìš”ì²­ ì¶”ì 
   - OpenTelemetry, Jaeger

4. **Chaos Engineering**
   - ì˜ë„ì ìœ¼ë¡œ ì¥ì•  ì£¼ì…
   - ìš°ë¦¬ì˜ Slowloris ì‹¤í—˜ì˜ í™•ì¥

---

## ë¶€ë¡: ì°¸ê³  ìë£Œ

- [Geth JSON-RPC êµ¬í˜„](https://github.com/ethereum/go-ethereum/tree/master/rpc)
- [Cosmos SDK API Server](https://github.com/cosmos/cosmos-sdk/tree/main/server)
- [Go net/http Server ì†ŒìŠ¤](https://cs.opensource.google/go/go/+/refs/tags/go1.23.4:src/net/http/server.go)
- [docs/01_http_server_overview.md](./01_http_server_overview.md) - ì†ŒìŠ¤ ì½”ë“œ ë¶„ì„
- [docs/02_timeouts_read_write.md](./02_timeouts_read_write.md) - Timeout ê°€ì´ë“œ
- [docs/03_slowloris_experiment.md](./03_slowloris_experiment.md) - Slowloris ì‹¤í—˜
- [docs/04_shutdown_semantics.md](./04_shutdown_semantics.md) - Shutdown ì‹¤í—˜
